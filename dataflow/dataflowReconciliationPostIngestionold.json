{
	"name": "dataflowReconciliationPostIngestionold",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "synapse_dest_tempclaimdetails",
						"type": "DatasetReference"
					},
					"name": "sourceLiveSynapse"
				},
				{
					"dataset": {
						"referenceName": "Control_File",
						"type": "DatasetReference"
					},
					"name": "ControlFile_old"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ADLSSinkDataset_Data_Flow",
						"type": "DatasetReference"
					},
					"name": "GenerateReconcileReport"
				}
			],
			"transformations": [
				{
					"name": "AggregateLiveData"
				},
				{
					"name": "JoinLiveDatawithControlFile"
				},
				{
					"name": "DerivedStatusColumn"
				}
			],
			"script": "source(output(\n\t\tclaimid as integer,\n\t\tclaim_amount as integer,\n\t\tclaim_status as string,\n\t\tclaim_date as timestamp,\n\t\tfn as string,\n\t\tlname as string,\n\t\tclaim_month as integer,\n\t\tclaim_year as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> sourceLiveSynapse\nsource(output(\n\t\tagreegate_claim_id as integer,\n\t\tagreegate_claim_amount as integer,\n\t\tagreegate_claim_month as integer,\n\t\tagreegate_claim_year as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false) ~> ControlFile_old\nsourceLiveSynapse aggregate(groupBy(claim_year,\n\t\tclaim_month),\n\tclaim_amount = sum(claim_amount)) ~> AggregateLiveData\nAggregateLiveData, ControlFile_old join(claim_year == agreegate_claim_year\n\t&& claim_month == agreegate_claim_month,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> JoinLiveDatawithControlFile\nJoinLiveDatawithControlFile derive(claim_month = claim_month,\n\t\tclaim_year = claim_year,\n\t\tclaim_amount = claim_amount,\n\t\tagreegate_claim_amount = agreegate_claim_amount,\n\t\tagreegate_claim_id = iif(claim_amount==agreegate_claim_amount,'Reconciliation Successful','Reconciliation Failed')) ~> DerivedStatusColumn\nDerivedStatusColumn sink(allowSchemaDrift: true,\n\tvalidateSchema: true,\n\tpartitionFileNames:[(concat('Reconciliation_Result',toString(currentTimestamp()),'.txt'))],\n\tmapColumn(\n\t\tclaim_month,\n\t\tclaim_year,\n\t\tclaim_amount,\n\t\tagreegate_claim_amount,\n\t\tStatus = agreegate_claim_id\n\t),\n\tpartitionBy('hash', 1)) ~> GenerateReconcileReport"
		}
	}
}